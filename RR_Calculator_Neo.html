<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <title>Trade Manager by Kelizo</title>
  <style>
    @font-face {
      font-family: 'calcFont';
      src: url('fonts/Prosche-Regular.otf') format('opentype');
      font-weight: normal;
      font-style: normal;
    }
    @font-face {
      font-family: 'titlFont';
      src: url('fonts/Acknowledgement.otf') format('opentype');
      font-weight: normal;
      font-style: normal;
    }
    body {
      overflow: auto;
      font-family: 'Segoe UI', sans-serif;
      background: rgb(227, 240, 255);
      padding: 0;
      color: #333;
      margin: 0;
    }
    .pageHead{
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 1600px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      background: linear-gradient(to right, #1A3B5D, #0B2643);
      padding: 20px 0;
      border-radius: 10px;
      margin-top: 10px;
    }
    .page-title {
      font-family: 'titlFont', serif; 
      margin: 0;
      text-align: center;
      white-space: nowrap;
      font-size: 70px;
      color: #ffffff;
      font-weight: 700;
      letter-spacing: 10px;
      animation: fadeIn 1s ease-in-out;
      transition: all 0.3s ease;
      text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.4);
    }
    .page-title:hover {
      transform: scale(1.02);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeIn2 {
      from { opacity: 0; transform: translateX(-30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes fadeIn3 {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .title-group h2 {
      font-family: 'Segoe UI', sans-serif;
      flex-direction: column;
      margin: 5px 0;
    }
    .landscape-container {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: flex-start;
      gap: 10px;
      flex-wrap: nowrap;
      width: 100%;
      max-width: 1600px;
      margin: 0 auto;
    }
    .calculator-title {
      font-family: 'calcFont', serif; 
      padding: 25px 10px;
      color: white;
      width: auto;
      border-radius: 5px;
      background: #414756;
      font-size: 30px;
      font-weight: bold;
      letter-spacing: 5px;
      text-align: center;
      box-shadow: 0 4px 12px #414756bd;
    }
    .calculator-title:hover {
      background: #232429;
      box-shadow: none;
      cursor: pointer;
    }
    .form-section {
      flex: 1;
      flex-grow: 0;
      flex-shrink: 0;
      min-width: 330px;
      width: 100%;
      background:#FBFBFD;
      border: 11px solid #D3DCE6;
      padding: 20px;
      color: #003d73;
      border-radius: 40px;
      box-shadow: 2px 4px 15px #414756bd;
      font-family: 'Segoe UI', sans-serif;
      animation: fadeIn2 1s ease-in-out;
      transition: all 0.3s ease;
      overflow: hidden;
    }
    label {
      font-size: 14px;
      display: inline-block;
      font-family: 'Segoe UI', sans-serif; 
      margin-top: 5px;   
    }
    input[type="number"] {
      display: block;
      position: relative;
      font-family: 'Segoe UI', sans-serif;
      padding: 10px;
      font-size: 14px;
      background: #e3f0ff;
      border: 1px solid #414756;
      border-radius: 10px;
      align-items: center;
    }
    .input-group {
      width: 100%;
      box-sizing: border-box;
    }
    .input-group label {
      display: block;
      width: 100%;
    }
    .input-group input {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border-radius: 30px;
      background: #e3f0ff;
      font-size: 14px;
      border: 1px solid #414756;
      margin-top: 5px;
    }
    .dropdown-wrapper {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      width: 100%;
    }
    .dropdown-group {
      flex: 1; /* Each takes equal space */
      display: flex;
      flex-direction: column;
    }
    .dropdown-group2 {
      flex: 1;
      display: flex;
      width: 50%;
      flex-direction: row;
      flex-wrap: nowrap;
      align-items: center;
      justify-content: flex-start;
    }
    .custom-dropdown {
      position: relative;
      width: 100%;
      cursor: pointer;
    }
    .custom-dropdown .selected {
      background: #1E4E79;
      color: white;
      padding: 8px 12px;
      border-radius: 30px;
      -webkit-user-select: none;
      user-select: none;
      box-shadow: 0 4px 5px #414756a8;
    }
    .custom-dropdown .selected:hover {
      background: rgb(30, 72, 110);
      box-shadow: none;
    }
    .custom-dropdown .options {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 4px 12px #414756;
      display: none;
      z-index: 99;
    }
    .custom-dropdown .options div {
      padding: 8px 12px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .custom-dropdown .options div:hover {
      background: #41475633;
      color: #003d73;
    }
    button {
      font-family: 'Segoe UI', sans-serif; 
      width: 33%;
      padding: 10px;
      background: #414756;
      color: #e3f0ff;
      font-weight: bold;
      font-size: 20px;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      box-shadow: 0 4px 5px #41475686;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .button-container {
      display: flex;
      justify-content: flex-end;
    }
    button:hover {
      background: #232429;
      box-shadow: none;
    }
    .output-title {
      color: white;
      width: auto;
      font-size: 25px;
      font-weight: bold;
      letter-spacing: 1px;
      text-align: center;
      animation: fadeIn 1s ease-in-out;
      transition: all 0.3s ease;
    }
    .opTittle-tooltip{
      display:block; 
      font-size: 12px; 
      text-align: right;
      width: 100%;
      margin-right: 10px;
      color:rgba(255, 255, 255, 0.651);
      animation: fadeIn 1s ease-in-out;
      transition: all 0.3s ease;
    }
    .msg-tooltip{
      display:none; 
      font-size: 12px; 
      text-align: center;
      width: 100%;
      margin-right: 10px;
      color:#003d73;
      animation: fadeIn 1s ease-in-out;
      transition: all 0.3s ease;
    }
    table {
      border-collapse:collapse;
      background-color: #fff;
      overflow: auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      font-family: 'Segoe UI', sans-serif;
      min-width: 100%;
      animation: fadeIn3 1s ease-in-out;
      transition: all 0.3s ease;
      scroll-behavior:smooth;
      width: 100%;
    }
    th, td {
      padding: 6px 10px;
      text-align: center;
      border-bottom: 1px solid #87b8e2;
    }
    th {
      padding: 14px 60px;
      background-color: #003d73;
      color: #fff;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }
    tr:hover {
      background-color:#41475633;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    td.price-copy-cell {
      align-items: center;
      justify-content: flex-end;
      white-space: nowrap;
      gap: 4px;
    }
    .copy-btn {
      padding: 2px;
      font-size: 14px;
      margin: 0;
      background-color: transparent;
      color: inherit; /* Inherit hover row text color */
      width:14%  
    }
    .copy-btn:hover {
      background: #97bfe9;
      color:#003d73
    }
    .delete-btn {
      padding: 2px;
      font-size: 14px;
      margin: 0;
      background-color: transparent;
      color: inherit;
      width: 14%;
    }
    .delete-btn:hover {
      background: #97bfe9;
      color:#003d73
    } 
    .charges-section {
      background:#003d73;
      color: #e3f0ff;
      padding: 10px;
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: none;
      flex-flow: column;
      align-items: center;
      flex-direction: column;
      justify-content: flex-start;
      gap:10px;
      max-height: 430px;
      margin-bottom: 10px;
      transition: opacity 0.3s ease;
      opacity: 0;
    }
    .charges-section ul {
      padding: 0 10px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      flex-wrap: nowrap;
      justify-content: flex-start;
      margin: 0;
    }
    .charges-section li {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    .charges-section .label {
      font-weight: 500; 
    }
    .charges-section .value {
      text-align: right;
      min-width: 80px;
    }
    .charges-section .highlight {
      color: #d9534f;
      font-weight: bold;
    }
    .charges-section.visible {
      display: flex;
      opacity: 1;
    }
    .output {
      flex:1;
      min-width: 0;
      max-width: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .outputHead {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        padding: 10px 0 5px;
        box-shadow: 2px 4px 10px #414756bd;
        border-radius: 40px 40px 0 0;
        animation: fadeIn 1s ease-in-out;
        transition: all 0.3s ease;
        background: #003d73;
        gap: 3px;
    }
    .charges-section.visible {
      opacity: 1;
    }
    .charges-toggle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      font-size: 16px;
      color: #245488;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .charges-content {
      max-height: 0;
      width: 100%;
      overflow: hidden;
      opacity: 0;
      flex-direction: column;
      justify-content: flex-start;
      gap:10px;
      transition: max-height 0.6s ease, opacity 0.5s ease;
    }
    .charges-collapsed .charges-content {
      max-height: 1000px;
      display: flex;
      opacity: 1;
    }
    #toggleArrow {
      color:#003d73;
      margin-left: -90px;
      margin-top: 5px;
      font-size: 10px;
      transition: transform 0.6s ease;
    }
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      max-width: 100%;
      text-align: left;
      display:block;
      border-radius: 10px;
    }
    .table-wrapper table {
      margin-left: 0; /* remove auto centering */
      table-layout: auto;
      width: max-content;
      overflow-x: auto;
    }
    .page-title {
      position: relative;
    }
    .branding {
      font-size: 12px;
      text-align: right;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.8);
      font-style: italic;
      letter-spacing: 0.5px;
    }
    .price-colored {
      font-weight: bold;
      padding: 6px 10px;
      border-radius: 6px;
      color: white;
      display: inline-block;
      min-width: 90px;
    }
    .charges-header {
      display: flex;
      width: 100%;
      justify-content: space-between;
      cursor: pointer;
      font-weight: bold;
      background-color:#e3f0ff;
      color:#003d73;
      padding: 10px;
      box-sizing: border-box;
      vertical-align: middle;
      border: 2px solid #003d73;
      border-radius: 10px;
      font-size: 16px;
    }
    .charges-label,.charges-quantity {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .charges-quantity {
      align-items: flex-end;
    }
    .charges-arrow {
      font-size: 18px;
      padding: 0 10px;
    }
    @keyframes fadeSlideLeft {
      from {
        opacity: 0;
        transform: translateX(50px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    @keyframes fadeSlideUp {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-50px);
      }
    }
    @keyframes fadeSlideUpShrink {
      from {
        opacity: 1;
        transform: scale(1);
      }
      to {
        opacity: 0;
        transform: scale(0);
      }
    }
    .table-fadeIn {
      animation: fadeSlideLeft 0.6s ease-in-out;
    }
    .table-fadeOut{
      animation: fadeSlideUpShrink 0.6s ease-in-out;
    }
    #outputTittle.fade-in {
      animation: fadeSlideLeft 0.6s ease-in-out;
    }
    #OPTtooltip.fade-in{
      animation: fadeSlideLeft 0.6s ease-in-out;
    }
    #resultTableBody.fade-in {
      animation: fadeSlideLeft 0.6s ease-in-out;
    }
    #resultTableBody.fade-out {
      animation: fadeSlideUp 0.6s ease-in-out;
    }
    #outputTittle.fade-out {
      animation: fadeSlideUp 0.6s ease-in-out;
    }
    #OPTtooltip.fade-out{
      animation: fadeSlideUp 0.6s ease-in-out;
    }
    #chargesDetails {
      opacity: 0;
      transform: translateX(-40px);
      transition: transform 0.5s ease, opacity 0.5s ease;
      pointer-events: none; /* prevents accidental interaction when hidden */
    }
    #chargesDetails.visible {
      opacity: 1;
      transform: translateX(0);
      pointer-events: auto;
    }
    #chargesPlaceholder {
      opacity: 0;
      transform: translateX(-40px);
      transition: transform 0.5s ease, opacity 0.5s ease;
    }
    #chargesPlaceholder.visible {
      opacity: 1;
      transform: translateX(0);
    }
    #result.fade-out {
      opacity: 0;
      transition: opacity 0.4s ease-out;
    } 
  #backdrop {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.4); /* dim layer */
    -webkit-backdrop-filter: blur(4px);           /* blur effect */
    backdrop-filter: blur(4px);
    z-index: 9997;
    
  }
  #popupOverlay {
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    padding: 0 10px;
    box-sizing: border-box;
    display: none;
    justify-content: space-around;
    background: transparent;
    align-items: center;
    z-index: 9998;
    width: 100%;
  }
  #basketPopup {
    box-sizing: border-box;
    width: 100%;
    min-height: 490px;
    max-width: 1374px;
    display: none;
    flex-direction: column;
    align-items: flex-end;
    background: rgb(227, 240, 255);
    padding: 10px;
    box-sizing: border-box;
    z-index: 9999;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
  }
  .table-basketWrapper{
    overflow-x: auto; 
    overflow-y: auto; 
    width: 100%;
    max-width: 100%;
    max-height: 400px;
    text-align: left;
    border-radius: 10px;
    display: block;
  }
    .table-basketWrapper table {
    table-layout: auto;
    font-size: 13px;
    overflow-x: auto; 
    overflow-y: auto; 
  }
  
  @media (max-width: 860px) {
    body {
      background: linear-gradient(to right, #1A3B5D, #0B2643);
    }
    .pageHead {
      box-shadow: none;
      margin: 10px 0 0;
      padding: 0;
    }
    .landscape-container {
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto; 
    }
    .calculator-title{
      padding: 20px;
      font-size: 40px;
    }
    .form-section {
      width: 100%;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
    }
    .output {
      flex: 1;
      width: 100%;
      border-radius: 10px;
      overflow-x: auto;
    }
    .outputHead{
      background: transparent;
      box-shadow: none;
    }
    .output-title{
      font-size: 22px;
      letter-spacing: 0;
      overflow-x: hidden;
      border-radius: 10px;
    }
    .opTittle-tooltip{
      text-align: center;
      color: white;
      font-size: 10px;
    }
    .table-wrapper {
      border: 1px solid white;
      box-sizing: border-box;
    }
    .table-wrapper table {
      width: max-content;
      table-layout: auto;
      overflow-x: auto;
    }
    th {
      padding: 10px 15px;
      letter-spacing: 0;
    }
    .page-title{
      font-size: 50px;
      letter-spacing: .5px;
      margin-top: 10px;
    }
    #basketPopup{
      min-height: 600px ;
    }
    #toggleBasketBtn {
      scale: 0.8;
      margin: 0px !important;
    }
    #scrollableArea {
      display: block !important;
    }
  }


  </style>
</head>
<body>
  <div style="display: flex;
              flex-direction: column;
              flex-wrap: nowrap;
              align-items: center;
              gap: 10px;
              margin: 0 10px;">
    <div class="pageHead">
      <div  style="display:flex;flex-direction:column;">
        <h2 class="page-title" style="display: flex;flex-direction: column;align-items: flex-end;">TRADE MANAGER</h2>
        <h2 class="branding" id="brand">by Kelizo</h2> 
      </div>
    </div>
  <div class="landscape-container">
    <div class="form-section"> 
      <div>
        <div style="
          display: flex;
          width: 100%;
          flex-direction: row;
          justify-content: space-between;
          margin: 8px 0px;">
          <div class="dropdown-group2">
            <div style="font-size: 15px;letter-spacing: 0;font-weight: bold;">MODE&nbsp;</div>
            <input type="hidden" id="modeDropdown" value="slBased">
            <div class="custom-dropdown" data-input="modeDropdown" style="width: 140px; letter-spacing: 0;">
              <div class="selected" style="
                text-align: right;
                padding: 5px;
                border-radius: 5px;
                background: #414756;
                font-size: 12px;
                ">
                Levels by SL</div>
              <div class="options" style="font-size: 12px; display: none; color:#232429 ;">
                <div data-value="slBased"style= "padding: 5px;text-align: right;">Levels by SL</div>
                <div data-value="lotBased"style= "padding: 5px;text-align: right;">Levels by Qty</div>
                <div data-value="netPNL"style= "padding: 5px;text-align: right;">Calculate Net P&L</div>
              </div>
            </div>
          </div>

          <button id="resetCalculator" 
                  title="Click to reset calculator"
                  style="
                    width:28px;
                    border-radius: 30px;
                    padding:0;">‚Ü∫
          </button>
        </div>
        <div class="calculator-title" >CALCULATOR</div>
      </div>
      <hr style="color: #003d73; height: 2px;margin-bottom: 10px;"></hr>
      <div id="chargesPlaceholder"></div>

      <div class="dropdown-wrapper">
        <div class="dropdown-group">
          <label id="brokerLabel">Broker:</label>
          <input type="hidden" id="brokerDropdown" value="fyers">
          <div aria-labelledby="brokerLabel" class="custom-dropdown" data-input="brokerDropdown">
            <div class="selected">Fyers</div>
            <div class="options">
              <div data-value="fyers">Fyers</div>
              <div data-value="upstox">Upstox</div>
              <div data-value="zerodha">Zerodha</div>
            </div>
          </div>
        </div>

        <div class="dropdown-group">
          <label id="executionLabel">Execution:</label>
          <input type="hidden" id="executionDropdown" value="Intraday">
          <div class="custom-dropdown" data-input="executionDropdown" aria-labelledby="executionLabel">
            <div class="selected">Intraday</div>
            <div class="options">
              <div data-value="Intraday">Intraday</div>
              <div data-value="Delivery">Delivery</div>
            </div>
          </div>
        </div>
        <div class="dropdown-group">
          <label id="positionLabel">Position:</label>
          <input type="hidden" id="positionDropdown" value="long">
          <div aria-labelledby="positionLabel" class="custom-dropdown" data-input="positionDropdown">
            <div class="selected">Long</div>
            <div class="options">
              <div data-value="long">Long</div>
              <div data-value="short">Short</div>
            </div>
          </div>
        </div>
      </div>

      <div class="input-group">
        <label>Entry Price ‚Çπ:<br>
        <input type="number" id="EntryPrice" step="0.01"></label>
      </div>
      

<!-- Stoploss input (for slBased) -->
<div class="input-group" id="stoplossGroup">
  <label for="stopLossPrice">Stoploss Price ‚Çπ:<br>
    <input type="number" id="stopLossPrice" step="0.01">
  </label>
</div>

<!-- Exit input (for netPNL) -->
<div class="input-group" id="exitGroup" style="display: none;">
  <label for="exitPrice">Exit Price ‚Çπ:<br>
    <input type="number" id="exitPrice" step="0.01">
  </label>
</div>

<!-- Quantity input (for lotBased) -->
<div class="input-group" id="quantityGroup" style="display: none;">
  <label for="lotQuantity">Quantity:<br>
    <input type="number" id="lotQuantity" step="1" min="1">
  </label>
</div>

<!-- Risk input (for lotBased) and (for slBased)  -->
<div class="input-group" id="riskGroup">
  <label for="riskAmount">Risk Amount ‚Çπ:<br>
  <input type="number" id="riskAmount" step="0.01"></label>
</div>
<!-- Quantity input (for netPNL) -->
<div class="input-group" id="qtyGroup" style="display: none;">
  <label for="qtyValue">Quantity:<br>
  <input type="number" id="qtyValue" step="0.01"></label>
</div>


      <div class="button-container">
        <button onclick="calculateExitPrice()">Calculate</button></div>
      <hr style="color: #003d73; height: 2px;margin-bottom: 0px; margin-top: 0px;"></hr>
      <div class="charges-section" id="chargesDetails">
        <div class="charges-header" id="chargesHeader" onclick="toggleCharges()">
          <div class="charges-label">
            <div>Charges</div>
            <div>Breakdown</div>
          </div>
          <div class="charges-arrow" id="toggleArrow" >‚Æõ</div>
          <div class="charges-quantity">
            <div>Quantity:</div>
            <div id="quantityValue"></div>
          </div>
        </div>
        <div id="chargeBreakdown" class="charges-content"></div>
      </div>
    </div>
    <div class="output">
      <div class="outputHead">       
        <div class="output-title" id="outputTittle">Welcome to trade manager</div>
        <div class="opTittle-tooltip"id ="OPTtooltip">Table will populate after calculation.</div>
      </div>
      <div class="table-wrapper" id="result">
        <table class="mainTable">
          <thead>
            <tr>
              <th>Target</th>
              <th>Gross P&L</th>
              <th>Charges</th>
              <th>‚âàNet P&L</th>
              <th>Price</th>
              <th>Fib Level</th>
            </tr>
          </thead>
          <tbody id="resultTableBody">
            <tr><td colspan="2" style="text-align: center; color: #999;">No data yet</td></tr>
          </tbody>
        </table>
      </div>
      <div class="msg-tooltip"id ="msg">Use an inverse Fibonacci with 0 as breakeven price , 1 as 1:R price and activate -1,2,3,4,5,6 levels to draw the levels in you chart.</div>
    </div>
  </div>
  <div id="scrollableArea" style="height: 100px;display: none;"></div> <!-- acts as bottom padding -->
</div>

<div id="backdrop"></div>
<div id="popupOverlay">
  <div id="basketPopup">
    <h3 style="width: 100%; text-align: center;margin: 15px 0px;">üõí Basket Summary</h3>
    <hr style="
      height: 5px;
      color: #003d73;
      background: #003d73;
      width: 100%;
      border-radius: 5px;
    ">
    <div class="table-basketWrapper" id="basketItems">
      <table id="basketTable">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Qty</th>
            <th>Position</th>
            <th>Entry</th>
            <th>Exit</th>
            <th>Gross P/L</th>
            <th>Charges</th>
            <th>Net P/L</th>
          </tr>
        </thead>
        <tbody>
            <tr><td colspan="2" style="text-align: center;font-size: 15px; color: #999;">No items yet</td></tr>
        </tbody>
      </table>
    </div>
    <div style="
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      width: 100%;">
      <div id="basketTotals" style="margin-top: 10px;" ></div>
      <div style="display:flex; flex-direction: row;gap: 6px;" >
        <button type="button" onclick="exportBasketToTXT()" style="    
          width: 60px;
          height: 30px;
          display: flex;
          align-items: center;
          flex-direction: row;
          font-size: 12px;
          justify-content: center;
          padding: 10px;">Save</button>
        <label for="importTxtFile" style="display:none">import
          <input type="file" id="importTxtFile" accept=".txt" multiple="" style="display:none;">
        </label>
        <button type="button" onclick="document.getElementById('importTxtFile').click()" style="    
          width: 60px;
          height: 30px;
          display: flex;
          align-items: center; 
          flex-direction: row;
          font-size: 12px;
          justify-content: center;
          padding: 10px;">Import</button>

        <button type="button" onclick="clearBasket()" style="    
          width: 60px;
          height: 30px;
          display: flex;
          align-items: center;
          flex-direction: row;
          font-size: 12px;
          justify-content: center;
          padding: 10px;">Empty</button>
      </div>
    </div>
  </div>
</div>


<button type="button" id="toggleBasketBtn" style="
  position: fixed;
  bottom: 0px;
  right: 0;
  margin: 20px;
  z-index: 9999;
  width: 90px;
">üõí Basket</button>

  <script>

let basket = [];
function updateModeInputs() {
  const mode = document.getElementById("modeDropdown").value;

  // Hide all by default
  document.getElementById("stoplossGroup").style.display = "none";
  document.getElementById("quantityGroup").style.display = "none";
  document.getElementById("qtyGroup").style.display = "none";
  document.getElementById("riskGroup").style.display = "none";
  document.getElementById("exitGroup").style.display = "none";


  // Show only the relevant one
  if (mode === "slBased") {
    document.getElementById("stoplossGroup").style.display = "block";
    document.getElementById("riskGroup").style.display = "block";
  } else if (mode === "lotBased") {
    document.getElementById("quantityGroup").style.display = "block";
    document.getElementById("riskGroup").style.display = "block";
  } else if (mode === "netPNL") {
    document.getElementById("exitGroup").style.display = "block";
    document.getElementById("qtyGroup").style.display = "block";
  }
}
 




    document.querySelectorAll('.custom-dropdown').forEach(dropdown => {
      const selected = dropdown.querySelector('.selected');
      const options = dropdown.querySelector('.options');
      selected.addEventListener('click', () => {
        document.querySelectorAll('.custom-dropdown .options').forEach(opt => {
          if (opt !== options) opt.style.display = 'none';
        });
        options.style.display = options.style.display === 'block' ? 'none' : 'block';
      });
      options.querySelectorAll('div').forEach(option => {
        option.addEventListener('click', () => {
          const inputId = dropdown.dataset.input;
          document.getElementById(inputId).value = option.dataset.value;
          selected.textContent = option.textContent;
          options.style.display = 'none';

          if (inputId === 'modeDropdown') {
            updateModeInputs();  
          }
        });
      });
    });
    // Close dropdown if clicked outside
    document.addEventListener('click', function (e) {
      document.querySelectorAll('.custom-dropdown').forEach(dropdown => {
        if (!dropdown.contains(e.target)) {
          dropdown.querySelector('.options').style.display = 'none';
        }
      });
    });
    let broker = 'fyers', isShort = false, isIntraday = true, mode = "slBased";
    function updateSelectionState() {
      mode = document.getElementById("modeDropdown").value;
      broker = document.getElementById("brokerDropdown").value;
      isShort = document.getElementById("positionDropdown").value === "short";
      isIntraday = document.getElementById("executionDropdown").value === "Intraday";
      
    }
    function updateSelections() {
      const mode= document.getElementById("modeDropdown").value;
      const broker = document.getElementById("brokerDropdown").value;
      const execution = document.getElementById("executionDropdown").value;
      const position = document.getElementById("positionDropdown").value;
      const isShort = (position === "short");
      const isIntraday = (execution === "Intraday");
      // Do something with these updated values...
      console.log({ mode, broker, execution, position, isShort, isIntraday });
    }
    function calculateCharges(entry, exit, qty, isShort, isIntraday, broker, ) {
      updateSelectionState();
      const configs = {
        fyers: {
          brokerage: (val, isIntraday) => Math.min(20, (isIntraday ? 0.0003 : 0.003) * val),
          dpCharges: isIntraday => isIntraday ? 0 : 12.5,
          stt: (sellVal, totalVal, isIntraday) => isIntraday ? 0.00025 * sellVal : 0.001 * totalVal,
          stamp: (buyVal, isIntraday) => isIntraday ? 0.00003 * buyVal : 0.00015 * buyVal
        },
        upstox: {
          brokerage: (val, isIntraday) => isIntraday ? Math.min(20, 0.001 * val) : Math.min(20, 0.025 * val),
          dpCharges: isIntraday => isIntraday ? 0 : 20,
          stt: (sellVal, totalVal, isIntraday) => isIntraday ? 0.00025 * sellVal : 0.001 * totalVal,
          stamp: (buyVal, isIntraday) => isIntraday ? 0.00003 * buyVal : 0.00015 * buyVal
        },
        zerodha: {
          brokerage: (val, isIntraday) => isIntraday ? Math.min(20, 0.0003 * val) : 0,
          dpCharges: isIntraday => isIntraday ? 0 : 15.34,
          stt: (sellVal, totalVal, isIntraday) => isIntraday ? 0.00025 * sellVal : 0.001 * sellVal,
          stamp: (buyVal, isIntraday) => isIntraday ? 0.00003 * buyVal : 0.00015 * buyVal
        }
      };
      const cfg = configs[broker];
      if (!cfg) return { total: 0, turnover: 0, brkBuy: 0, brkSell: 0, stt: 0, exch: 0, gst: 0, sebi: 0, ipft: 0, dp: 0, stamp: 0 };
      const buy = isShort ? exit : entry;
      const sell = isShort ? entry : exit;
      const buyValue = buy * qty;
      const sellValue = sell * qty;
      const turnover = (buy + sell) * qty;
      const brkBuy = cfg.brokerage(buyValue, isIntraday);
      const brkSell = cfg.brokerage(sellValue, isIntraday);
      const stt = cfg.stt(sellValue, buyValue + sellValue, isIntraday);
      const exch = 0.0000297 * turnover;
      const sebi = 0.000001 * turnover;
      const ipft = 0.000001 * turnover;
      const dp = cfg.dpCharges(isIntraday);
      const gst = 0.18 * (brkBuy + brkSell + exch + sebi + ipft + dp);
      const stamp = cfg.stamp(buyValue, isIntraday);
      const total = brkBuy + brkSell + stt + exch + gst + sebi + ipft + dp + stamp;
      return { total, turnover, brkBuy, brkSell, stt, exch, gst, sebi, ipft, dp, stamp };
    }
    function showCharges(entry, exit, qty, isShort, netPnL=0) {  
      updateSelectionState();       
      const charges = calculateCharges(entry, exit, qty, isShort, isIntraday, broker);
      const color = netPnL > 0 ? 'lime' : 'red';
      const html = `
            <ul>
                
                <li>
                    <span>Turnover:</span> <span><span style="color:lime;font-weight:bold;">‚Çπ${charges.turnover.toFixed(2)}</span>
                </li>
                <li>
                    <span>Brokerage (Buy):</span> <span>‚Çπ${charges.brkBuy.toFixed(2)}</span>
                </li>
                <li>
                    <span>Brokerage (Sell):</span> <span>‚Çπ${charges.brkSell.toFixed(2)}</span>
                </li>
                <li>
                    <span>Net Brokerage:</span> 
                    <span style="color: red; font-weight: bold;">‚Çπ${(charges.brkSell + charges.brkBuy).toFixed(2)}</span>
                </li>
                <li>
                    <span>STT:</span> <span>‚Çπ${charges.stt.toFixed(2)}</span>
                </li>
                <li>
                    <span>Exchange Txn:</span> <span>‚Çπ${charges.exch.toFixed(3)}</span>
                </li>
                <li>
                    <span>GST:</span> <span>‚Çπ${charges.gst.toFixed(2)}</span>
                </li>
                <li>
                    <span>SEBI Charges:</span> <span>‚Çπ${charges.sebi.toFixed(2)}</span>
                </li>
                <li>
                    <span>NSE IPFT Charges:</span> <span>‚Çπ${charges.ipft.toFixed(2)}</span>
                </li>
                <li>
                    <span>DP Charges:</span> <span>‚Çπ${charges.dp.toFixed(2)}</span>
                </li>
                <li>
                    <span>Stamp Duty:</span> <span>‚Çπ${charges.stamp.toFixed(2)}</span>
                </li>
            </ul>
            <ul>
              <li>
                <strong>Total Charges:</strong> 
                <span style="color: red; font-weight: bold;">‚Çπ${charges.total.toFixed(3)}</span>
              </li>
              <li>
                <strong>Net P&L:</strong> 
                <span style="color: ${color}; font-weight: bold;">‚Çπ${netPnL.toFixed(2)}</span>
              </li>
            </ul>
            `;
      
      document.getElementById("chargeBreakdown").innerHTML = html;
      const breakdown = document.getElementById("chargesDetails");
      // Reset animation if already visible
      breakdown.classList.remove("visible");
      void breakdown.offsetWidth; // force reflow
      breakdown.classList.add("visible");       
    }
    function getPriceColorStyle(price, breakeven, oneRPrice,Q) {
      const distance = Math.abs(price - breakeven);
      const minChange = Math.abs(oneRPrice - breakeven);
      let percent = distance / minChange;
      if (Math.abs(distance) < 0.01) {
        return `background: #003d73; color: white;`; // Deep blue at breakeven
      }
      if (price>breakeven) {
        // Price is above breakeven ‚Üí vivid red shades
        const g = Math.round(200-15*percent);
        const r = Math.round(140-30*percent);       
        const b = Math.round(140-30*percent);
        return `background: rgb(${r}, ${g}, ${b});`;
      } else {
        // Price is below breakeven ‚Üí vivid green shades
        const r = Math.round(200-15*percent);
        const g = Math.round(140-30*percent);
        const b = Math.round(140-30*percent);
        return `background: rgb(${r}, ${g}, ${b});`;
      }
    }
    function calculateExitPrice() {
      const header = document.getElementById("chargesHeader");
      header.title = "Choose a row before clicking";
      updateSelectionState();
      const E = parseFloat(document.getElementById("EntryPrice").value);  
      const mode = document.getElementById("modeDropdown").value;
      let Q = 0;
      let R = 0;
      let S = 0;
      if (mode !== "netPNL"){
        if (mode === "slBased") {       
          S = parseFloat(document.getElementById("stopLossPrice").value);
          R = parseFloat(document.getElementById("riskAmount").value);
          if (!E || !S || !R || isNaN(E) || isNaN(S) || isNaN(R) || Math.abs(R) < 1|| E==S) {
            showError("Please enter valid numbers in all fields.")
            return;
          }
          if (isShort?S<E:S>E){
            showError(`Stoploss should be ${isShort ? "greater" : "less"} than entry price!`);
            return;
          }
          Q = Math.floor((R/Math.abs(E-S)));
          document.getElementById('quantityValue').innerText = Q.toFixed(0);
          if (Q<=0){
            showError("Not risking enough for minimum quantity")
            return;
          }   
        }  
        else if (mode === "lotBased") {
          Q = parseFloat(document.getElementById("lotQuantity").value);
          R = parseFloat(document.getElementById("riskAmount").value);
          S = isShort ? E + (R / Q) : E - (R / Q);
          document.getElementById('quantityValue').innerText = Q.toFixed(0);   
          if (!Q || !E || !R || isNaN(E) || isNaN(R) || isNaN(Q)|| Math.abs(R) < 1 || Math.abs(Q) < 1) {
            showError("Please enter valid numbers in all fields.")
            return;
          }
        }
        
        const RSLcharge = calculateCharges(E, S, Q, isShort, isIntraday,broker).total
        const Echarge = calculateCharges(E, E, Q, isShort, isIntraday, broker).total;
        const targets = [-R-RSLcharge,-R,E-Echarge, 0, R, 2 * R, 3 * R, 4 * R, 5 * R, 6 * R];
        const labels = ["Real SL","True SL","Entry", "Breakeven", "1:R", "1:2R", "1:3R", "1:4R", "1:5R", "1:6R"];
        let rows = [];
        targets.forEach((target, i) => {  
          let mid, grossPnL, netPnL, charges;
          if (i === 0) {
            mid = S;
            charges = RSLcharge;
            grossPnL = isShort ? (E - mid) * Q : (mid - E) * Q;
            netPnL = grossPnL - charges;
          }else if (i === 2) {
            mid = E;
            charges = Echarge
            grossPnL = 0;
            netPnL = -charges;
          }else {
            let low = E, high = E;
            if (isShort) {
              if (target >= 0) {
                high = E;
                low = E - Math.max(100, (target / Q) * 5);
              } else {
                high = E - Math.min(-100, (target / Q) * 5);
                low = E;
              }
            } else {
              if (target >= 0) {
                low = E;
                high = E + Math.max(100, (target / Q) * 5);
              } else {
                low = E + Math.min(-100, (target / Q) * 5);
                high = E;
              }
            }
            let attempts = 0;
            while (attempts++ < 50) {
              mid = (low + high) / 2;
              charges = calculateCharges(E, mid, Q, isShort, isIntraday, broker).total;
              grossPnL = isShort ? (E - mid) * Q : (mid - E) * Q;  
              netPnL = grossPnL - charges;
              if (Math.abs(netPnL - target) < 0.01) break;
              if (netPnL < target) {
                if (isShort) high = mid;
                else low = mid;
              } else {
                if (isShort) low = mid;
                else high = mid;
              }
            }
          }
          rows.push({ label: labels[i], pnl: target, price: mid, net: netPnL,gross: grossPnL, charge:charges });
        });
        const breakeven = rows[3].price;  // Breakeven (net P&L = 0)
        const oneRPrice = rows[4].price;  // 1:R level (net P&L = R)
        
        if (Math.abs(rows[1].charge) >= 0.5*R) {
          showError(`WARNING! More than 50% of the risk is charges.(‚Çπ${rows[1].charge.toFixed(2)})`);
          return;
        }      
        function fib(price) {
          const range = Math.abs(oneRPrice - breakeven);
          if (range < 0.0001) return 0;
          else {
            return isShort
              ? ((breakeven - price) / range) * 100
              : ((price - breakeven) / range) * 100;
          }
        }
        let tableHTML = `
          <table>
            <thead>
              <tr>
                <th>Target</th>
                <th>Gross P&L</th>
                <th>Charges</th>
                <th>‚âàNet P&L</th>
                <th>Price</th>
                <th>Fib Level</th>
              </tr>
            </thead>
            <tbody id="resultTableBody">         
              ${rows.slice(0, 10).map((r, idx) => `
                <tr class="clickable-row" data-price="${r.price}" data-label="${r.label}" data-netpnl="${r.net}" title="Click to view detailed charges">
                  <td>${r.label}</td>
                  <td>${r.gross.toFixed(2)}</td>
                  <td>${r.charge.toFixed(3)}</td>
                  <td>${r.net.toFixed(2)}</td>
                  <td class="price-copy-cell">
                    <span class="price-colored" style="${getPriceColorStyle(r.price, breakeven, oneRPrice)}">
                      ‚Çπ${r.price.toFixed(2)}
                    </span>
                    <button class="copy-btn copySymbol" data-icon="üóê" data-copy="${r.price.toFixed(2)}" title="Copy to clipboard">üóê</button>
                  </td> 
                  <td>${fib(r.price).toFixed(2)}%</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        `;
        const resultContainer = document.getElementById("result");
        resultContainer.innerHTML = tableHTML;
        const resultTable = resultContainer.querySelector("table");
        const OPtittle = document.getElementById("outputTittle");
        const OPTtool = document.getElementById("OPTtooltip");
        const tbody = document.getElementById("resultTableBody");
        const msg = document.getElementById("msg");
        if (resultTable) {
          resultTable.classList.add("table-fadeIn");
          OPtittle.classList.add("fade-in");
          OPTtool.classList.add("fade-in");
        }             
        const placeholder = document.getElementById("chargesPlaceholder");
        const breakdown = document.getElementById("chargesDetails");
        OPtittle.textContent = `Exit levels for ${isShort ? "short" : "long"} position (Qty: ${Q})`;
        OPTtool.textContent="Tap a row to view detailed charges."
        msg.style.display = "block";
        placeholder.appendChild(breakdown);
        breakdown.style.display = 'flex';    
        void breakdown.offsetWidth;
        void placeholder.offsetWidth;
        breakdown.classList.add("visible");
        placeholder.classList.add("visible");    
        const content = document.getElementById("chargeBreakdown");
        const arrow = document.getElementById("toggleArrow");
        content.style.display = "flex";    
        if (arrow.textContent==="‚Æô") {
          content.style.maxHeight = "0px";
          content.style.opacity = "0";
          arrow.textContent = "‚Æõ"; // Make sure arrow reflects expanded state
        }
        setTimeout(() => {
          document.getElementById("chargeBreakdown").innerHTML = ""},600);
      }
      else {
        S = parseFloat(document.getElementById("exitPrice").value);
        Q = parseFloat(document.getElementById("qtyValue").value);
        document.getElementById('quantityValue').innerText = Q.toFixed(0);
        if (!E || !S || !Q || isNaN(E) || isNaN(S) || Q<1) {
          showError("Please enter valid numbers in all fields.")
          return;  
        }
        const grossPNL =isShort? (E-S)*Q : (S-E)*Q;
        const netPNL =grossPNL- calculateCharges(E, S, Q, isShort, isIntraday, broker).total;
        const color2 = grossPNL > 0 ? 'lime' : 'red';
        const color = netPNL > 0 ? 'lime' : 'red';
        let tableHTML = `
        <table>
          <tr>
            <th>Entry ‚Çπ</th>
            <th>Exit ‚Çπ</th>
            <th>Quantity</th>
            <th>Gross P&L</th>
            <th>Charges</th>
            <th>‚âàNet P&L</th>
          </tr>
          <tbody id="resultTableBody">
            <tr class="clickable-row" data-price="${S}" data-label="Gross SL" data-netpnl="${netPNL}" title="Click to view detailed charges">
              <td>${E.toFixed(2)}</td>
              <td>${S.toFixed(2)}</td>
              <td>${Q.toFixed(2)}</td>
              <td style="color:${color2}">${grossPNL.toFixed(2)}</td>
              <td style="color:red;">${calculateCharges(E, S, Q, isShort, isIntraday, broker).total.toFixed(3)}</td>
              <td style="color:${color};font-weight:bold;">${(netPNL).toFixed(2)}</td>
            </tr>
          </tbody>
        </table>
        `;
        const resultContainer = document.getElementById("result");
        resultContainer.innerHTML = tableHTML;
        const resultTable = resultContainer.querySelector("table");
        const OPtittle = document.getElementById("outputTittle");
        const OPTtool = document.getElementById("OPTtooltip");
        const tbody = document.getElementById("resultTableBody");
        if (resultTable) {
          resultTable.classList.add("table-fadeIn");
          OPtittle.classList.add("fade-in");
          OPTtool.classList.add("fade-in");
        }             
        const placeholder = document.getElementById("chargesPlaceholder");
        const breakdown = document.getElementById("chargesDetails");
        OPtittle.textContent=`Net P&L for Qty: ${Q}`;
        OPTtool.textContent="Tap a row to view detailed charges."
        placeholder.appendChild(breakdown);
        breakdown.style.display = 'flex';    
        void breakdown.offsetWidth;
        void placeholder.offsetWidth;
        breakdown.classList.add("visible");
        placeholder.classList.add("visible");    
        const content = document.getElementById("chargeBreakdown");
        const arrow = document.getElementById("toggleArrow");
        content.style.display = "flex";    
        if (arrow.textContent==="‚Æô") {
          content.style.maxHeight = "0px";
          content.style.opacity = "0";
          arrow.textContent = "‚Æõ"; // Make sure arrow reflects expanded state
        }
        setTimeout(() => {
          document.getElementById("chargeBreakdown").innerHTML = ""},600);
      }
      updateText()
    }
    document.addEventListener("click", function(e) {
      if (e.target.classList.contains("copy-btn")) {
        e.stopPropagation(); // prevents triggering row click 
        const valueToCopy = e.target.getAttribute("data-copy");
        const messageElement = document.getElementById("OPTtooltip"); // ‚úÖ reference your message area
        navigator.clipboard.writeText(valueToCopy).then(() => {
          e.target.innerText = "‚úì";
          // ‚úÖ Show "Price copied" message
          if (messageElement) {
            messageElement.innerText = "Price copied ‚úì";
            messageElement.style.color = "lime";
            // Restore the original message after 1.5s
           setTimeout(() => {
              const originalIcon = e.target.getAttribute("data-icon") || "üóê";
              e.target.innerText = originalIcon;
              messageElement.innerText = "Tap a row to view detailed charges.";
              messageElement.style.color = ""; // reset to default
              updateText()
            }, 1500);
          }
        }).catch(() => {
          alert("Failed to copy.");
        });
      }
    });
    document.addEventListener('click', function (e) {
      if (e.target.closest(".copy-btn")) return;
      if (e.target.closest('.clickable-row')) {
        const header = document.getElementById("chargesHeader");
        header.title = "Click to view detailed charges";
        const row = e.target.closest('.clickable-row');
        const price = parseFloat(row.getAttribute('data-price'));
        const netPnL = parseFloat(row.getAttribute('data-netpnl'));
        const mode = document.getElementById("modeDropdown").value;
        const E = parseFloat(document.getElementById("EntryPrice").value);
        const R = parseFloat(document.getElementById("riskAmount").value);  
        let Q = 1;
        if (mode === "slBased") {
          S = parseFloat(document.getElementById("stopLossPrice").value);
          Q = Math.round(R / Math.abs(E - S));
        }else if (mode === "netPNL") {
          Q = parseFloat(document.getElementById("qtyValue").value);
        }else if (mode === "lotBased") {
          Q = parseFloat(document.getElementById("lotQuantity").value);
        }
        if (!isNaN(netPnL)) {
            showCharges(E, price, Q, isShort, netPnL);
        } else {
            showCharges(E, price, Q, isShort, 0);
        }
        showFloatingPopup(e.pageX, e.pageY, row, (symbol) => {
          basket.push({
            symbol, // ‚úÖ new field
            label: row.getAttribute("data-label") || `Custom`,
            entry: E,
            exit: price,
            quantity: Q,
            grossPnL: isShort ? (E - price) * Q : (price - E) * Q,
            netPnL: netPnL,
            charges: calculateCharges(E, price, Q, isShort, isIntraday, broker).total,
            type:isShort?"Short":"Long",
            broker,
            mode
          });
          updateBasketUI();
        }); 
        // Show and ensure it stays visible
        const breakdown = document.getElementById("chargesDetails");
        breakdown.style.display = 'flex';
        breakdown.classList.add("visible");
        // Re-attach to placeholder if necessary
        const placeholder = document.getElementById("chargesPlaceholder");
        if (!placeholder.contains(breakdown)) {
            placeholder.appendChild(breakdown);
        }
        const content = document.getElementById("chargeBreakdown");
        const arrow = document.getElementById("toggleArrow");
        // If currently collapsed, expand it
        if (arrow.textContent === "‚Æõ") {
          content.style.maxHeight = "1000px";
          content.style.opacity = "1";
          arrow.textContent = "‚Æô"; // Make sure arrow reflects expanded state
        }
      }
    });
    function toggleCharges() {
      const content = document.getElementById("chargeBreakdown");
      const arrow = document.getElementById("toggleArrow");
      const header = document.getElementById("chargesHeader");
      const isVisible = content.style.maxHeight && content.style.maxHeight !== "0px";
      const messageElement = document.getElementById("OPTtooltip");
      if (!content || !content.innerHTML.trim()) {
        messageElement.innerText = "Choose a row to display charges!";
        messageElement.style.color = "red";
        setTimeout(() => {
              messageElement.innerText = "Tap a row to view detailed charges.";
              messageElement.style.color = ""; // reset to default
            }, 1500);
        return;
      } else {
        header.title = "Click to view detailed charges";
      }
      if (isVisible) {
        content.style.maxHeight = "0";
        content.style.opacity = "0";
        arrow.textContent = "‚Æõ";
      } else {
        content.style.maxHeight = "1000px";
        content.style.opacity = "1";
        arrow.textContent = "‚Æô";
      }
    }
    function showError(message) {
      const tbody = document.getElementById("resultTableBody");
      const OPtittle = document.getElementById("outputTittle");
      const OPTtool = document.getElementById("OPTtooltip");
      const msg = document.getElementById("msg");
      msg.style.display = "none";
      if (!tbody || !OPtittle || !OPTtool) return;
      // Step 1: Fade out
      tbody.classList.remove("fade-in");
      OPtittle.classList.remove("fade-in");
      OPTtool.classList.remove("fade-in");
      tbody.classList.add("fade-out");
      OPtittle.classList.add("fade-out");
      OPTtool.classList.add("fade-out");
      // Step 2: After fade-out, update content
      setTimeout(() => {
        OPtittle.textContent = "Calculator failed!";
        OPTtool.innerText = "Error üî¥";
        OPTtool.style.color = "red";
        tbody.innerHTML = `
          <tr>
            <td colspan="2" style="text-align: center; color: red;">${message}</td>
          </tr>`;
        // Remove fade-out and trigger fade-in
        tbody.classList.remove("fade-out");
        OPtittle.classList.remove("fade-out");
        OPTtool.classList.remove("fade-out");
        void tbody.offsetWidth;
        void OPtittle.offsetWidth;
        void OPTtool.offsetWidth;
        tbody.classList.add("fade-in");
        OPtittle.classList.add("fade-in");
        OPTtool.classList.add("fade-in");
      }, 600); // delay must match your CSS transition duration
      // Step 3: Reset after 3s
      setTimeout(() => {
        // Fade out current
        tbody.classList.remove("fade-in");
        OPtittle.classList.remove("fade-in");
        OPTtool.classList.remove("fade-in");
        tbody.classList.add("fade-out");
        OPtittle.classList.add("fade-out");
        OPTtool.classList.add("fade-out");
        setTimeout(() => {
          // Update with default
          OPtittle.textContent = "Welcome to trade manager";
          OPTtool.innerText = "Table will populate after calculation.";
          OPTtool.style.color = "";
          tbody.innerHTML = `
            <tr>
              <td colspan="2" style="text-align: center; color: #999;">No data yet</td>
            </tr>`;
          // Fade in again
          tbody.classList.remove("fade-out");
          OPtittle.classList.remove("fade-out");
          OPTtool.classList.remove("fade-out");
          void tbody.offsetWidth;
          void OPtittle.offsetWidth;
          void OPTtool.offsetWidth;
          tbody.classList.add("fade-in");
          OPtittle.classList.add("fade-in");
          OPTtool.classList.add("fade-in");
        }, 600); // fade-out duration
      }, 3000); // time to hold error message
      const placeholder = document.getElementById("chargesPlaceholder");
      const breakdown = document.getElementById("chargesDetails");
      const content = document.getElementById("chargeBreakdown");
      const arrow = document.getElementById("toggleArrow");
      if (content && breakdown && placeholder && arrow) {
        content.style.maxHeight = "0px";
        content.style.opacity = "0";
        arrow.textContent = "‚Æõ";
        setTimeout(() => {
          breakdown.classList.remove("visible");
          placeholder.classList.remove("visible");
        }, 500);
        setTimeout(() => {
          breakdown.style.display = "none";
          content.style.display = "none";
        }, 600);
      }
    }
    document.getElementById("resetCalculator").addEventListener("click", function () {
      const tbody = document.getElementById("resultTableBody");
      const OPtittle = document.getElementById("outputTittle");
      const OPTtool = document.getElementById("OPTtooltip");
      if(tbody && OPtittle && OPTtool ){
        tbody.classList.add("fade-out");
        OPtittle.classList.add("fade-out");
        OPTtool.classList.add("fade-out");
        OPTtool.innerText = "Calculator reset ‚úì";
        OPTtool.style.color = "lime";
      } 
      // Wait for animation to finish before hiding and resetting
      setTimeout(() => {
        // Reset all inputs
        document.getElementById("EntryPrice").value = '';
        document.getElementById("stopLossPrice").value = '';
        document.getElementById("exitPrice").value = '';
        document.getElementById("lotQuantity").value = '';
        document.getElementById("riskAmount").value = '';
        // Reset dropdowns
        const dropdowns = [
          { id: "modeDropdown", default: "slBased", label: "Levels by SL"},
          { id: "brokerDropdown", default: "fyers", label: "Fyers" },
          { id: "executionDropdown", default: "Intraday", label: "Intraday" },
          { id: "positionDropdown", default: "long", label: "Long" },
        ];
        dropdowns.forEach(({ id, default: val, label }) => {
          const input = document.getElementById(id);
          const wrapper = document.querySelector(`.custom-dropdown[data-input="${id}"]`);
          if (input && wrapper) {
            input.value = val;
            wrapper.querySelector(".selected").textContent = label;
          }
        });
        updateModeInputs();
        // Reset only the table body
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; color:  #999;">No data yet</td>
          </tr>`;
        tbody.classList.remove("fade-out"); // reset class
        void tbody.offsetWidth; 
        tbody.classList.add("fade-in");
        OPtittle.textContent="Welcome to trade manager";
        OPtittle.classList.remove("fade-out"); // reset class
        OPTtool.classList.remove("fade-out");
        void OPtittle.offsetWidth; 
        void OPTtool.offsetWidth; 
        OPtittle.classList.add("fade-in");
        OPTtool.classList.add("fade-in");  
        OPTtool.innerText = "Table will populate after calculation.";
        OPTtool.style.color = ""; // reset to default
      }, 400); // match the transition time in CSS
      // Clear charges info
      const placeholder = document.getElementById("chargesPlaceholder");
      const breakdown = document.getElementById("chargesDetails");
      const content = document.getElementById("chargeBreakdown");
      const arrow = document.getElementById("toggleArrow");
      if (content && breakdown && placeholder && arrow) {
        content.style.maxHeight = "0px";
        content.style.opacity = "0";
        arrow.textContent = "‚Æõ";
        setTimeout(() => {
          document.getElementById("quantityValue").textContent = '';
          document.getElementById("chargeBreakdown").innerHTML = '';
          breakdown.classList.remove("visible");
          placeholder.classList.remove("visible");
        }, 500);
        setTimeout(() => {
          breakdown.style.display = "none";
          content.style.display = "none";
        }, 600);
      }
      updateModeInputs();
    });

    function showFloatingPopup(x, y, row, onAdd) {
      // üßπ Remove existing popup
      document.getElementById("rowPopup")?.remove();
      // üì¶ Create wrapper
      const popup = document.createElement("div");
      popup.id = "rowPopup";
      popup.style.position = "absolute";
      popup.style.left = `${x + 10}px`; // Center relative to click (adjust if needed)
      popup.style.top = `${y - 60}px`;  // Appear above cursor
      popup.style.background = "transparent";
      popup.style.padding = "0";
      popup.style.zIndex = 9999;
      popup.style.fontSize = "14px";
      popup.style.minWidth = "140px";
      // üéØ Triangle pointer
      popup.innerHTML = `
        <div style="position: relative;display: flex; justify-content: center;">
          <div style="
            position: absolute;
            bottom: 0px;
            left: 41px;
            transform: translateX(0%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 11px solid #003d73;">
          </div>
          <button id="addToBasketBtn" style="padding: 4px; background: #003d73; color: #97bfe9; border: none; border-radius: 17px;; cursor: pointer;font-size: 12px; width: 80px;">
            üõí Add to Basket
          </button>
        </div>
      `;
      document.body.appendChild(popup);
      // Handle Add click
      document.getElementById("addToBasketBtn").addEventListener("click", () => {
        const symbol = prompt("Enter a symbol or name for this row:");
        if (symbol && symbol.trim() !== "") {
          onAdd(symbol.trim()); // pass the symbol to the add logic
          popup.remove();
        }
      });
      // Close on outside click
      setTimeout(() => {
        document.addEventListener("click", function closePopupOutside(ev) {
          if (!popup.contains(ev.target)) {
            popup.remove();
            document.removeEventListener("click", closePopupOutside);
          }
        });
      }, 10);
    }
    function updateBasketUI() {
      const basketItems = document.getElementById("basketItems");
      const basketTotals = document.getElementById("basketTotals");
      if (basket.length === 0) {
        const basketTableBody = document.getElementById("basketTableBody")
        basketTableBody.innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center; color: #999;">No items yet</td>
            </tr>`;
        basketTotals.innerHTML = "";
        return;
      }
      let html = `<table style="width: 100%; font-size: 13px;">
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Qty</th>
          <th>Position</th>
          <th>Entry</th>
          <th>Exit</th>
          <th>Gross P/L</th>
          <th>Charges</th>
          <th>Net P/L</th>
        </tr>
      </thead>
      <tbody id="basketTableBody">`;
      let totalGross = 0, totalNet = 0, totalChg = 0;
      basket.forEach((item,index) => {
        html += `
        
          <tr>
            <td style="padding: 15px 10px;">${item.symbol}</td>
            <td class="price-copy-cell">
              <span style="padding: 15px 10px;">
                ${item.quantity}
              </span>
              <button class="delete-btn" data-index="${index}" style="border:none;color:red;cursor:pointer;" tittle= "Click to delete row">üóë</button>
            </td>
            <td style="padding: 15px 10px;">${item.type}</td>
            <td style="padding: 15px 10px;">${item.entry.toFixed(2)}</td>
            <td style="padding: 15px 10px;">${item.exit.toFixed(2)}</td>
            <td style="padding: 15px 10px;font-weight:bold; color:${item.grossPnL>=0 ? 'limegreen' : 'red'};">‚Çπ${item.grossPnL.toFixed(2)}</td>
            <td style="padding: 15px 10px;font-weight:bold;color:red;">‚Çπ${item.charges.toFixed(2)}</td>
            <td style="padding: 15px 10px;font-weight:bold;color:${item.netPnL >= 0 ? 'limegreen' : 'red'};">‚Çπ${item.netPnL.toFixed(2)}</td>
          </tr>`;
        totalGross += item.grossPnL;
        totalNet += item.netPnL;
        totalChg += item.charges;
      });
      html += `</tbody></table>`;
      basketItems.innerHTML = html;
      basketTotals.innerHTML = `
        <hr style="
        height: 1px;
        color: #003d73;
        background: #003d73;
        width: 100%;
        border-radius: 5px;
        ">
        <ul style="list-style: none; padding: 0;">
          <li style="display: flex; justify-content: space-between;font-weight: bold;">
            <strong>Total Gross P&L: </strong><span style="color:${totalGross >= 0 ? 'green' : 'red'};">‚Çπ${totalGross.toFixed(2)}</span>
          </li>
          <li style="display: flex; justify-content: space-between;font-weight: bold; gap: 155px;">
            <strong>Total Charges: </strong><span style="color:red;">‚Çπ${totalChg.toFixed(2)}
          </li>
          <li style="display: flex; justify-content: space-between;font-weight: bold;">
            <strong>Net P&L: </strong><span style="color:${totalNet >= 0 ? 'green' : 'red'};">‚Çπ${totalNet.toFixed(2)}</span>
          </li>
        </ul>
      `;

    basketItems.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        const index = parseInt(this.getAttribute('data-index'));
        if (!isNaN(index)) {
          basket.splice(index, 1); // Remove item
          updateBasketUI();        // Refresh basket
        }
      });
    });
}
function clearBasket() {
  basket = [];
  updateBasketUI();
  const fileInput = document.getElementById("importTxtFile");
  if (fileInput) {
    fileInput.value = "";
  }
}
const popup = document.getElementById("basketPopup");
const backdrop = document.getElementById("backdrop");


document.getElementById("toggleBasketBtn").addEventListener("click", () => {
  const isVisible = getComputedStyle(popup).display === "flex";
  if (isVisible) {
    closePopup();
  } else {
    openPopup();
  }
});

function openPopup() {
  document.getElementById("popupOverlay").style.display = "flex";
  popup.style.display = "flex";
  backdrop.style.display = "block";
  document.body.style.overflow = "hidden";
}

function closePopup() {
  document.getElementById("popupOverlay").style.display = "none";
  popup.style.display = "none";
  backdrop.style.display = "none";
  document.body.style.overflow = "auto";
}
function exportBasketToTXT() {
  let txtContent = "";
  basket.forEach(item => {
    txtContent += `${item.symbol},${item.quantity},${item.type},${item.entry},${item.exit},${item.grossPnL},${item.charges},${item.netPnL}\n`;
  });

  const blob = new Blob([txtContent], { type: "text/plain" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "basket_data.txt";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}
document.getElementById("importTxtFile").addEventListener("change", function (event) {
  const files = Array.from(event.target.files);
  if (files.length === 0) return;

  let filesProcessed = 0;
  let newItems = [];

  files.forEach(file => {
    const reader = new FileReader();

    reader.onload = function (e) {
      const lines = e.target.result.trim().split("\n");

      for (let line of lines) {
        const parts = line.split(",");
        if (parts.length !== 8) continue;
        const [symbol, qty, type, entry, exit, grossPnL, charges, netPnL] = parts;
        newItems.push({
          symbol: symbol.trim(),
          quantity: parseFloat(qty),
          type: type.trim(),
          entry: parseFloat(entry),
          exit: parseFloat(exit),
          grossPnL: parseFloat(grossPnL),
          charges: parseFloat(charges),
          netPnL: parseFloat(netPnL),
        });
      }
      filesProcessed++;
      if (filesProcessed === files.length) {
        if (newItems.length > 0) {
          basket = basket.concat(newItems);
          updateBasketUI();
          event.target.value = ""; // reset input
        }else alert("Failed to import. File might be empty or formatted incorrectly.");
      };      
    }
    reader.readAsText(file);
  });
});


document.getElementById("popupOverlay").addEventListener("click", closePopup);
document.getElementById("basketPopup").addEventListener("click", function(event) {
  event.stopPropagation(); // This stops the click from closing the popup
});
function updateText() {
  const buttons = document.querySelectorAll(".copySymbol");
  buttons.forEach(btn => {
    btn.textContent = window.innerWidth < 860 ? "üìé" : "üóê";
  });
}
window.addEventListener("resize", updateText);
window.addEventListener("DOMContentLoaded", updateText);

  </script>
</body>
</html>
